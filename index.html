
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PT SPEKTRA MEGAH SEMESTA • Tension Load Cell & Lifting Gear Report</title>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --bg: #f5f7f9;
      --surface: #ffffff;
      --primary: #0C6B58;
      --primary-600: #0E7F67;
      --accent: #16B091;
      --text: #0B1220;
      --muted: #6B7280;
      --border: #E7ECF0;
      --shadow: 0 14px 30px rgba(0, 0, 0, .06);
      --radius: 16px;
      --danger: #dc2626;
      --warning: #f59e0b;
      --success: #10b981;
    }
    * {
      box-sizing: border-box
    }
    html,
    body {
      height: 100%;
      margin: 0;
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
    }
    /* ===== Layout ===== */
    .page {
      height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header {
      padding: 14px 18px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 10;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      max-width: 1600px;
      margin: 0 auto;
    }
    .brand svg {
      width: 38px;
      height: 38px;
      color: var(--primary)
    }
    .brand h1 {
      font-size: clamp(18px, 2.2vw, 26px);
      margin: 0;
      text-transform: uppercase;
    }
    .sub {
      color: var(--muted);
      font-size: 13px;
      text-transform: uppercase;
    }
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    /* ===== Sidebar Navigation ===== */
    .sidebar {
      width: 220px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      z-index: 5;
      flex-shrink: 0;
    }
    .nav-item {
      padding: 14px 24px;
      cursor: pointer;
      font-weight: 600;
      color: var(--muted);
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .nav-item:hover {
      background: #f8fafc;
      color: var(--primary);
    }
    .nav-item.active {
      color: var(--primary);
      border-left-color: var(--primary);
      background: #f0f9f7;
    }
    .nav-item svg {
      width: 20px;
      height: 20px;
    }
    /* ===== Content Area ===== */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 16px;
    }
    .page-content {
      flex: 1;
      overflow-y: auto;
      padding: 0 10px;
    }
    /* ===== Dashboard Page ===== */
    .dashboard-layout {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      height: calc(100vh - 180px);
      display: grid;
      grid-template-columns: 1.4fr .8fr;
      gap: 16px;
    }
    @media (max-width: 1024px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
        height: auto
      }
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .card h2 {
      margin: 0 0 6px 0;
      font-size: 18px
    }
    .helper {
      color: var(--muted);
      font-size: 12px
    }
    /* ===== Chart panel ===== */
    .chart-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0
    }
    .legend {
      display: flex;
      gap: 12px;
      flex-wrap: wrap
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block
    }
    .dot--1 {
      background: #1678FF
    }
    .dot--2 {
      background: #10B981
    }
    .dot--3 {
      background: #F59E0b
    }
    .canvasBox {
      position: relative;
      flex: 1 1 auto;
      min-height: 320px;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block
    }
    .cross {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      background: #CBD5E1;
      pointer-events: none;
      transform: translateX(-.5px)
    }
    .tip {
      position: absolute;
      min-width: 180px;
      max-width: 240px;
      background: #0b1220;
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, .25);
      font-size: 13px;
      pointer-events: none;
      transform: translate(-50%, -110%);
      white-space: nowrap
    }
    .tip .row {
      display: flex;
      justify-content: space-between;
      gap: 18px
    }
    .tip .k {
      opacity: .8
    }
    .tip .v {
      font-weight: 700
    }
    /* ===== Right panel ===== */
    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }
    .field {
      display: grid;
      gap: 6px
    }
    label {
      font-size: 13px;
      color: var(--muted)
    }
    input,
    select,
    button {
      font: inherit;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #FBFCFD;
    }
    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-600);
      box-shadow: 0 0 0 4px rgba(14, 127, 103, .12)
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #F0FDF9;
      color: var(--primary);
      border: 1px solid #D9F3EC;
      font-weight: 600;
      font-size: 12px
    }
    .led {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #c9cdd2;
      border: 1px solid #bfc5ca;
      box-shadow: inset 0 0 0 2px #fff9;
    }
    .led.green {
      background: #22c55e;
      border-color: #16a34a;
      box-shadow: 0 0 10px #22c55eaa, inset 0 0 0 2px #fff9
    }
    @keyframes blink {
      0%,
      60% {
        opacity: 1
      }
      61%,
      100% {
        opacity: .15
      }
    }
    .led.blink {
      animation: blink .8s linear infinite
    }
    .btn {
      padding: 10px 12px;
      border: 1px solid transparent;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff
    }
    .btn-outline {
      background: #fff;
      color: var(--primary);
      border-color: #CFE9E2
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn:active {
      transform: translateY(1px)
    }
    .kpi {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .display {
      padding: 10px 12px;
      border: 1px dashed #dfe6ea;
      border-radius: 12px;
      background: #fbfcfd;
      font-weight: 700
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }
    /* ===== Monitoring Page ===== */
    .monitoring-page {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }
    .monitoring-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-top: 14px;
    }
    .monitoring-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .monitoring-info {
      display: flex;
      gap: 20px;
      font-size: 14px;
      flex-wrap: wrap;
    }
    .info-item {
      display: flex;
      flex-direction: column
    }
    .info-label {
      color: var(--muted);
      font-size: 12px
    }
    .info-value {
      font-weight: 700
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th,
    td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: #f8fafc;
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
    }
    tr:hover {
      background: #f1f5f9
    }
    .mirror-chart {
      height: 200px;
      margin-top: 16px
    }
    /* ===== Report Page (Form) ===== */
    .form-container {
      background: var(--surface);
      padding: 28px;
      border-radius: var(--radius);
      max-width: 1000px;
      margin: 0 auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 10px;
    }
    .form-title {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
      color: var(--primary);
    }
    .form-progress {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: .2px;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #e2e8f0;
      border: 1px solid var(--border);
      overflow: hidden;
      margin: 10px 0 18px 0;
    }
    .progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transition: width .3s ease;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      margin: 0 0 16px 0;
      letter-spacing: .3px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: var(--muted);
      font-size: 14px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #FBFCFD;
      color: var(--text);
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    input::placeholder,
    textarea::placeholder {
      color: #94a3b8
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary-600);
      box-shadow: 0 0 0 4px rgba(14, 127, 103, .12);
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .form-row>* {
      grid-column: span 6;
    }
    .form-row>*.full {
      grid-column: 1 / -1;
    }
    .swl-row {
      display: grid;
      grid-template-columns: 1fr 160px;
      gap: 16px;
    }
    .form-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      background: var(--surface);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .05);
      margin-bottom: 20px;
    }
    .divider {
      height: 1px;
      background: var(--border);
      margin: 20px 0;
    }
    .form-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 26px;
      gap: 15px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    .form-btn {
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .3px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
      transition: all .2s ease;
      min-width: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .form-btn:hover {
      background: var(--primary-600);
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, .15);
    }
    .form-btn:active {
      transform: translateY(1px);
    }
    .form-btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--border);
    }
    .form-btn-outline:hover {
      background: #f0f9f7;
      border-color: var(--primary);
    }
    /* YES/NO toggles */
    .yn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
    }
    .yn-box {
      min-width: 80px;
      min-height: 44px;
      border: 2px solid var(--border);
      background: #f8fafc;
      color: var(--muted);
      font-weight: 700;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 15px;
      user-select: none;
      padding: 0 16px;
      transition: all .2s ease;
    }
    .yn-box:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: #f0fdfa;
    }
    .yn-box.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 4px 6px rgba(12, 107, 88, .2);
    }
    .readonly-field {
      background-color: #f1f5f9;
      color: #475569;
    }
    /* Image Upload Section */
    .image-upload-section {
      margin-top: 20px;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    .image-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #f8fafc;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
    }
    .image-preview {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e2e8f0;
      position: relative;
    }
    .image-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .image-preview .placeholder {
      color: var(--muted);
      font-size: 14px;
    }
    .image-info {
      padding: 12px;
    }
    .image-name {
      font-weight: 600;
      margin-bottom: 8px;
      word-break: break-all;
    }
    .image-actions {
      display: flex;
      gap: 8px;
    }
    .add-image-btn {
      width: 100%;
      padding: 15px;
      border: 2px dashed var(--border);
      border-radius: 12px;
      background: #f1f5f9;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      transition: all .2s ease;
      text-align: center;
    }
    .add-image-btn:hover {
      border-color: var(--primary);
      background: #e2f0ed;
      color: var(--primary);
    }
    .file-input {
      display: none;
    }
    footer {
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      font-weight: 700;
      letter-spacing: .3px;
      text-transform: uppercase;
    }
    /* ===== Responsive Design ===== */
    @media (max-width: 992px) {
      .sidebar {
        width: 70px;
      }
      .nav-item span {
        display: none;
      }
      .nav-item {
        justify-content: center;
        padding: 16px 0;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .form-row>* {
        grid-column: 1 / -1;
      }
      .swl-row {
        grid-template-columns: 1fr;
      }
      .form-footer {
        flex-direction: column;
      }
      .form-btn {
        width: 100%;
      }
      .image-grid {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 768px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
      }
      .monitoring-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .monitoring-info {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ===== Header ===== -->
    <header>
      <div class="brand">
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <path d="M38.7 17.2c-5.2 0-9.8 3.3-12.2 7.9C23.9 20.6 19.1 17 13.4 17 7 17 1.8 22.3 1.8 28.6c0 6.4 5.2 11.6 11.6 11.6 5.3 0 9.8-3.3 12.2-7.9 2.6 4.5 7.4 7.9 13.1 7.9 6.4 0 11.6-5.2 11.6-11.6S45.1 17.2 38.7 17.2Zm-25.3 18c-3.8 0-6.8-3.1-6.8-6.8S9.6 21.6 13.4 21.6c3.8 0 6.8 3.1 6.8 6.8s-3.1 6.8-6.8 6.8Zm25.3 0c-3.8 0-6.8-3.1-6.8-6.8s3.1-6.8 6.8-6.8c3.8 0 6.8 3.1 6.8 6.8s-3.1 6.8-6.8 6.8Z" fill="currentColor" />
        </svg>
        <div>
          <h1>PT SPEKTRA MEGAH SEMESTA</h1>
          <div class="sub">Tension Load Cell & Lifting Gear Report</div>
        </div>
      </div>
    </header>
    <main>
      <!-- ===== Sidebar Navigation ===== -->
      <nav class="sidebar">
        <div class="nav-item active" data-page="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          <span>Dashboard</span>
        </div>
        <div class="nav-item" data-page="monitoring">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <span>Monitoring</span>
        </div>
        <div class="nav-item" data-page="report">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <span>Report</span>
        </div>
      </nav>
      <!-- ===== Content Area ===== -->
      <div class="content-area">
        <div class="page-content">
          <!-- ===== Dashboard Page ===== -->
          <div id="dashboardPage" class="dashboard-layout">
            <!-- Left: Trend Chart -->
            <section class="card chart-wrap" aria-labelledby="chartTitle">
              <div class="row" style="justify-content:space-between;align-items:end">
                <div>
                  <h2 id="chartTitle">Trendchart • Value Load vs Time</h2>
                  <div class="helper">Interaktif: hover untuk lihat detail.</div>
                </div>
                <div class="legend">
                  <span class="chip"><i class="dot dot--1"></i>Value Load</span>
                  <span class="chip"><i class="dot dot--2"></i>Set Point</span>
                  <span class="chip"><i class="dot dot--3"></i>Zero</span>
                </div>
              </div>
              <div class="canvasBox" id="canvasBox">
                <canvas id="chart"></canvas>
                <div class="cross" id="cross" hidden></div>
                <div class="tip" id="tip" hidden>
                  <div class="row" style="margin-bottom:6px"><span class="k">Timestamp</span><span class="v" id="tipT">–</span></div>
                  <div class="row"><span class="k">Value Load</span><span class="v" id="tipV">–</span></div>
                </div>
              </div>
            </section>
            <!-- Right: Controls -->
            <aside class="card">
              <h2 style="margin-bottom:6px">Panel Kontrol</h2>
              <div class="grid">
                <!-- User -->
                <div class="field">
                  <label>Pengguna</label>
                  <div class="row">
                    <input type="text" id="username" value="Fulan Bin Fulan" readonly />
                    <span id="led" class="led" title="Indicator"></span>
                  </div>
                </div>
                <!-- Timestamp & Location -->
                <div class="field">
                  <label>Timestamp & Lokasi</label>
                  <div class="row" style="gap:10px">
                    <input type="text" id="ts" value="—" readonly style="flex:1; min-width: 120px;">
                    <input type="text" id="loc" value="Batam" style="flex:1; min-width: 100px;">
                  </div>
                </div>
                <!-- Mode + Execution -->
                <div class="field">
                  <label>Mode & Eksekusi</label>
                  <div class="row" style="gap:10px">
                    <select id="mode" style="min-width:140px">
                      <option value="Operate" selected>Operate</option>
                      <option value="Standby">Standby</option>
                    </select>
                    <button id="btnExec" class="btn btn-primary" type="button">Execution</button>
                    <span class="badge" id="stateBadge">Idle</span>
                  </div>
                </div>
                <!-- Setpoint + Unit -->
                <div class="row">
                  <div class="field" style="flex:1">
                    <label>Set Point Value</label>
                    <input id="setpoint" type="number" step="0.01" value="100.00" />
                  </div>
                  <div class="field" style="width:140px">
                    <label>Unit</label>
                    <select id="unit">
                      <option value="mg">mg</option>
                      <option value="g">g</option>
                      <option value="kg" selected>kg</option>
                      <option value="ton">ton</option>
                    </select>
                  </div>
                </div>
                <!-- Displays -->
                <div class="kpi">
                  <div class="field">
                    <label>Value Load (Real)</label>
                    <div id="valReal" class="display">0.00</div>
                  </div>
                  <div class="field">
                    <label>Value Set</label>
                    <div id="valSet" class="display">100.00</div>
                  </div>
                </div>
                <!-- Zero Calibration -->
                <div class="actions">
                  <button id="btnZero" class="btn btn-outline" type="button">Zero Calibration</button>
                </div>
              </div>
            </aside>
          </div>
          <!-- ===== Monitoring Page ===== -->
          <div id="monitoringPage" style="display:none">
            <div class="monitoring-page">
              <div class="monitoring-card">
                <div class="monitoring-header">
                  <h2>Monitoring Data</h2>
                  <button id="btnSave" class="btn btn-primary" type="button">Save as Image</button>
                  <div class="monitoring-info">
                    <div class="info-item">
                      <span class="info-label">Operator</span>
                      <span class="info-value" id="monitorOperator">Fulan Bin Fulan</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Value Set</span>
                      <span class="info-value" id="monitorSetpoint">100.00 kg</span>
                    </div>
                  </div>
                </div>
                <!-- Mirror Chart with Full Scale -->
                <div class="canvasBox mirror-chart" id="mirrorBox">
                  <canvas id="mirrorChart"></canvas>
                </div>
                <!-- Data Table -->
                <table id="dataTable">
                  <thead>
                    <tr>
                      <th>No.</th>
                      <th>Timestamp</th>
                      <th>Value Load (Real)</th>
                      <th>No.</th>
                      <th>Timestamp</th>
                      <th>Value Load (Real)</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody">
                    <!-- Data akan ditambahkan otomatis -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- ===== Report Page (Form) ===== -->
          <div id="reportPage" style="display:none">
            <div class="form-container">
              <div class="form-header">
                <div class="form-title">Thorough Examination Report — Lifting Gear</div>
                <div class="form-progress" id="form-progress">Page 1 of 8</div>
              </div>
              <div class="progress-bar" aria-hidden="true">
                <div class="progress" id="form-progress-bar"></div>
              </div>
              <!-- SECTION 1: Document Header -->
              <section class="form-section active" data-section="1">
                <h2 class="section-title">1. Document Header</h2>
                <div class="form-card">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Form No.</label>
                      <input type="text" id="formNo" name="formNo" value="SMS/629/F/002/Rev. 0" readonly class="readonly-field" />
                    </div>
                    <div class="form-group">
                      <label>Certificate No</label>
                      <input type="text" id="certificateNo" name="certificateNo" value="SMS/SAIPEM-LGI/RS/III-25/033" readonly class="readonly-field" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Date of Thorough Examination</label>
                      <input type="date" id="dateOfExamination" name="dateOfExamination" value="2025-03-06" />
                    </div>
                    <div class="form-group">
                      <label>Date of Report</label>
                      <input type="date" id="dateOfReport" name="dateOfReport" value="2025-03-06" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group full">
                      <label>Title</label>
                      <input type="text" id="reportTitle" name="reportTitle" value="THOROUGH EXAMINATION REPORT OF LIFTING GEARS" readonly class="readonly-field" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Compliance Standard</label>
                      <input type="text" id="compliance" name="compliance" value="Complies with LEEA Technical Requirements" readonly class="readonly-field" />
                    </div>
                    <div class="form-group">
                      <label>Regulatory Reference</label>
                      <input type="text" id="reference" name="reference" value="PERMEN No.08/2020" readonly class="readonly-field" />
                    </div>
                  </div>
                </div>
              </section>
              <!-- SECTION 2: Identity of Parties & Location -->
              <section class="form-section" data-section="2">
                <h2 class="section-title">2. Identity of Parties & Location</h2>
                <div class="form-card">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Employer (Name)</label>
                      <input type="text" id="employerName" name="employerName" value="PT. SAIPEM INDONESIA" />
                    </div>
                    <div class="form-group">
                      <label>Employer (Address)</label>
                      <input type="text" id="employerAddress" name="employerAddress" value="Alamanda Tower, 3rd Floor Jl. TB. Simatupang Kav. 23-24, Cilandak Barat Jakarta Selatan 12430 – Indonesia" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Examination Location (Site Name)</label>
                      <input type="text" id="siteName" name="siteName" value="PT. Saipem Indonesia (Karimun Yard)" />
                    </div>
                    <div class="form-group">
                      <label>Examination Location (Address)</label>
                      <input type="text" id="siteAddress" name="siteAddress" value="Jl. Raja Haji Fisabililah Desa Pangke, Kec. Meral, Kab. Karimun" />
                    </div>
                  </div>
                </div>
              </section>
              <!-- SECTION 3: Equipment Identity -->
              <section class="form-section" data-section="3">
                <h2 class="section-title">3. Equipment Identity</h2>
                <div class="form-card">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Equipment Description</label>
                      <input type="text" id="equipmentDesc" name="equipmentDesc" value="ROUND SLING" readonly class="readonly-field" />
                    </div>
                    <div class="form-group">
                      <label>ID Number</label>
                      <input type="text" id="idNumber" name="idNumber" value="NRS-RS-006740" readonly class="readonly-field" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Manufacturer</label>
                      <input type="text" id="manufacturer" name="manufacturer" value="ULTRA" readonly class="readonly-field" />
                    </div>
                    <div class="form-group">
                      <label>Safety Factor</label>
                      <input type="text" id="safetyFactor" name="safetyFactor" value="7:1" readonly class="readonly-field" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Length (mm)</label>
                      <input type="number" id="length" name="length" value="2500" readonly class="readonly-field" />
                    </div>
                    <div class="form-group">
                      <label>Standard Reference</label>
                      <input type="text" id="standardRef" name="standardRef" value="BS EN 1492" readonly class="readonly-field" />
                    </div>
                  </div>
                  <div class="swl-row">
                    <div class="form-group">
                      <label>SWL (Safe Working Load)</label>
                      <input type="text" id="swl" name="swl" value="2 ton" readonly class="readonly-field" />
                    </div>
                    <div class="form-group">
                      <label>Date of Manufacture</label>
                      <input type="date" id="dateOfManufacture" name="dateOfManufacture" value="2024-08-09" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Date of Last Thorough Examination</label>
                    <input type="date" id="dateOfLastExamination" name="dateOfLastExamination" value="" />
                  </div>
                </div>
              </section>
              <!-- SECTION 4: Technical Test Results -->
              <section class="form-section" data-section="4">
                <h2 class="section-title">4. Technical Test Results</h2>
                <div class="form-card">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Visual Test</label>
                      <select id="visualTestResult" name="visualTestResult">
                        <option value="">Select</option>
                        <option value="OK" selected>OK</option>
                        <option value="NOT OK">NOT OK</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>NDT Test</label>
                      <select id="ndtTestResult" name="ndtTestResult">
                        <option value="">Select</option>
                        <option value="OK">OK</option>
                        <option value="NOT OK">NOT OK</option>
                        <option value="-" selected>-</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Function Test</label>
                      <select id="functionTest" name="functionTest">
                        <option value="">Select</option>
                        <option value="OK">OK</option>
                        <option value="NOT OK">NOT OK</option>
                        <option value="-" selected>-</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Load Test</label>
                      <select id="loadTest" name="loadTest">
                        <option value="">Select</option>
                        <option value="OK">OK</option>
                        <option value="NOT OK">NOT OK</option>
                        <option value="-" selected>-</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Name Stamping</label>
                    <select id="nameStamping" name="nameStamping">
                      <option value="">Select</option>
                      <option value="OK" selected>OK</option>
                      <option value="NOT OK">NOT OK</option>
                    </select>
                  </div>
                </div>
              </section>
              <!-- SECTION 5: Examination Category & Interval -->
              <section class="form-section" data-section="5">
                <h2 class="section-title">5. Examination Category & Interval</h2>
                <div class="form-card">
                  <div class="form-group">
                    <label>Is this the first examination after installation or assembly at a new site or location?</label>
                    <div class="yn-row" data-name="first_exam">
                      <div class="yn-box" data-name="first_exam" data-value="YES">YES</div>
                      <div class="yn-box" data-name="first_exam" data-value="NO" selected>NO</div>
                    </div>
                  </div>
                  <div class="form-group" id="installedCorrectlyGroup" style="display: none;">
                    <label>Has the equipment been installed correctly?</label>
                    <div class="yn-row" data-name="installed_correctly">
                      <div class="yn-box" data-name="installed_correctly" data-value="YES">YES</div>
                      <div class="yn-box" data-name="installed_correctly" data-value="NO">NO</div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Within an interval of 6 months?</label>
                      <div class="yn-row" data-name="interval_6">
                        <div class="yn-box" data-name="interval_6" data-value="YES">YES</div>
                        <div class="yn-box" data-name="interval_6" data-value="NO" selected>NO</div>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>Within an interval of 12 months?</label>
                      <div class="yn-row" data-name="interval_12">
                        <div class="yn-box" data-name="interval_12" data-value="YES" selected>YES</div>
                        <div class="yn-box" data-name="interval_12" data-value="NO">NO</div>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>In accordance with an examination scheme?</label>
                    <div class="yn-row" data-name="exam_scheme">
                      <div class="yn-box" data-name="exam_scheme" data-value="YES">YES</div>
                      <div class="yn-box" data-name="exam_scheme" data-value="NO" selected>NO</div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>After the occurrence of exceptional circumstances?</label>
                    <div class="yn-row" data-name="exceptional_event">
                      <div class="yn-box" data-name="exceptional_event" data-value="YES">YES</div>
                      <div class="yn-box" data-name="exceptional_event" data-value="NO" selected>NO</div>
                    </div>
                  </div>
                </div>
              </section>
              <!-- SECTION 6: Defects Findings & Follow-up -->
              <section class="form-section" data-section="6">
                <h2 class="section-title">6. Defects Findings & Follow-up</h2>
                <div class="form-card">
                  <div class="form-group">
                    <label>Identification of any part found to have a defect which is or could become a danger to persons and a description of the defect (if none state NONE)</label>
                    <textarea id="defectDescription" name="defectDescription">None</textarea>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Is the above a defect which is of immediate danger to persons?</label>
                      <div class="yn-row" data-name="hazard_immediate">
                        <div class="yn-box" data-name="hazard_immediate" data-value="YES">YES</div>
                        <div class="yn-box" data-name="hazard_immediate" data-value="NO" selected>NO</div>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>Is the above a defect which is not yet but could become a danger to persons? (If YES state the date by when)</label>
                      <div class="yn-row" data-name="hazard_potential">
                        <div class="yn-box" data-name="hazard_potential" data-value="YES">YES</div>
                        <div class="yn-box" data-name="hazard_potential" data-value="NO" selected>NO</div>
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Date by when</label>
                      <input type="date" id="repairDeadline" name="repairDeadline" />
                    </div>
                    <div class="form-group">
                      <label>Particulars of any tests carried out as part of the examination (if none state NONE)</label>
                      <input type="text" id="additionalTests" name="additionalTests" value="None" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Particulars of any repair, renewal or alteration required to remedy the defect identified above</label>
                    <textarea id="repairDetails" name="repairDetails">None</textarea>
                  </div>
                  <div class="divider"></div>
                  <div class="form-group">
                    <label>IS THIS EQUIPMENT FIT FOR PURPOSE?</label>
                    <div class="yn-row" data-name="fit_for_purpose">
                      <div class="yn-box" data-name="fit_for_purpose" data-value="YES" selected>YES</div>
                      <div class="yn-box" data-name="fit_for_purpose" data-value="NO">NO</div>
                    </div>
                  </div>
                </div>
              </section>
              <!-- SECTION 7: Officers & Authorization -->
              <section class="form-section" data-section="7">
                <h2 class="section-title">7. Officers & Authorization</h2>
                <div class="form-card">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Name & Qualification of person making this report</label>
                      <input type="text" id="inspectorName" name="inspectorName" value="Kamarul Zaman" />
                    </div>
                    <div class="form-group">
                      <label>Qualification/Position of Inspector</label>
                      <input type="text" id="inspectorQualification" name="inspectorQualification" value="Lifting Gear Inspector" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Name of the person authenticating this report</label>
                      <input type="text" id="authenticatorName" name="authenticatorName" value="Menas Eka Putra" />
                    </div>
                    <div class="form-group">
                      <label>Position/Authority</label>
                      <input type="text" id="authenticatorRole" name="authenticatorRole" value="Technical Authority" />
                    </div>
                  </div>
                  <div class="divider"></div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Latest date by which next thorough examination must be carried out</label>
                      <input type="date" id="nextExaminationDate" name="nextExaminationDate" value="2026-03-05" />
                    </div>
                    <div class="form-group">
                      <label>Name and address of the person making and authenticating this report</label>
                      <input type="text" id="companyName" name="companyName" value="PT. Spektra Megah Semesta" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Company Address</label>
                      <input type="text" id="companyAddress" name="companyAddress" value="Jl. Taman Cilandak Raya Blok E No.19, Cilandak Barat, Jakarta Selatan 12430- INDONESIA" />
                    </div>
                    <div class="form-group">
                      <label>Contact (Tel/Fax/Email/Website)</label>
                      <input type="text" id="companyContact" name="companyContact" value="Phone No.:(021) 22763643 Fax No.:+62(21) 22763643 Website: spektramegahsemesta.com email: marketing@spektra-ms.co.id" />
                    </div>
                  </div>
                </div>
              </section>
              <!-- SECTION 8: Import Image -->
              <section class="form-section" data-section="8">
                <h2 class="section-title">8. Import Image</h2>
                <div class="form-card">
                  <div class="image-upload-section">
                    <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                    <label for="fileInput" class="add-image-btn">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                      </svg>
                      Add Image
                    </label>
                    <div class="image-grid" id="imageGrid">
                      <!-- Gambar akan ditambahkan di sini secara dinamis -->
                    </div>
                  </div>
                </div>
              </section>
              <div class="form-footer">
                <button type="button" class="form-btn form-btn-outline" onclick="prevFormSection()">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                  </svg>
                  Previous
                </button>
                <button type="button" class="form-btn" id="exportReportBtn"> <!-- Tombol Export Baru -->
                  Export Report
                </button>
                <button type="button" class="form-btn" onclick="nextFormSection()">
                  Next
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer>© SURIOTA 2025 • SURGE - Measure Management</footer>
  </div>
  <script>
    // ===== Navigation Logic =====
    const navItems = document.querySelectorAll('.nav-item');
    const pages = {
      dashboard: document.getElementById('dashboardPage'),
      monitoring: document.getElementById('monitoringPage'),
      report: document.getElementById('reportPage')
    };
    navItems.forEach(item => {
      item.addEventListener('click', () => {
        // Update active nav item
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        // Show selected page
        const pageName = item.dataset.page;
        Object.values(pages).forEach(page => page.style.display = 'none');
        pages[pageName].style.display = 'block';
        // Special handling for monitoring page
        if (pageName === 'monitoring') {
          fitCanvas();
          drawMirror();
        }
        // Special handling for dashboard page - ensure chart is drawn
        if (pageName === 'dashboard') {
            // Small delay to ensure DOM is fully rendered
            setTimeout(() => {
                fitCanvas();
                draw(); // Draw the chart when switching to dashboard
            }, 10);
        }
      });
    });
    // ===== Dashboard & Monitoring Logic (from original) =====
    const cvs = document.getElementById('chart');
    const box = document.getElementById('canvasBox');
    const cross = document.getElementById('cross');
    const tip = document.getElementById('tip');
    const tipT = document.getElementById('tipT');
    const tipV = document.getElementById('tipV');
    const ts = document.getElementById('ts');
    const loc = document.getElementById('loc');
    const mode = document.getElementById('mode');
    const btnExec = document.getElementById('btnExec');
    const badge = document.getElementById('stateBadge');
    const led = document.getElementById('led');
    const setpointEl = document.getElementById('setpoint');
    const unitEl = document.getElementById('unit');
    const valReal = document.getElementById('valReal');
    const valSet = document.getElementById('valSet');
    const username = document.getElementById('username');
    // Monitoring elements
    const monitorOperator = document.getElementById('monitorOperator');
    const monitorSetpoint = document.getElementById('monitorSetpoint');
    const tableBody = document.getElementById('tableBody');
    const mirrorCvs = document.getElementById('mirrorChart');
    const mirrorBox = document.getElementById('mirrorBox');
    const btnSave = document.getElementById('btnSave');
    // ===== State =====
    let running = false;
    let zeroOffsetKg = 0;
    let currentStep = 0;
    const buffer = [];
    const monitoringData = [];
    const MAX_SEC = 120;
    const SAMPLE_MS = 5000;
    const unitFactor = {
      mg: 1e6,
      g: 1e3,
      kg: 1,
      ton: 1 / 1000
    };
    // ===== Functions =====
    function readSensorKg() {
      const spKg = toKg(parseFloat(setpointEl.value || 0), unitEl.value);
      if (spKg <= 0) return 0;
      const pct = currentStep / 100;
      let vKg = spKg * pct;
      const noise = (Math.random() - 0.5) * spKg * 0.01;
      return Math.max(0, Math.min(spKg, vKg + noise));
    }
    function fromKg(vKg, unit) {
      return vKg * unitFactor[unit];
    }
    function toKg(v, unit) {
      return v / unitFactor[unit];
    }
    function refreshLED() {
      if (running && mode.value === 'Operate') {
        led.className = 'led green blink';
      } else if (mode.value === 'Operate') {
        led.className = 'led green';
      } else {
        led.className = 'led';
      }
    }
    setInterval(() => {
      const d = new Date();
      ts.value = d.toLocaleString('id-ID', {
        hour12: false
      });
    }, 500);
    function fitCanvas() {
      if (!box || !cvs) return;
      const r = box.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      cvs.width = Math.floor(r.width * dpr);
      cvs.height = Math.floor(r.height * dpr);
      // Also fit mirror chart if on monitoring page
      if (mirrorBox && mirrorCvs) {
          const mr = mirrorBox.getBoundingClientRect();
          mirrorCvs.width = Math.floor(mr.width * dpr);
          mirrorCvs.height = Math.floor(mr.height * dpr);
      }
    }
    window.addEventListener('resize', () => {
        fitCanvas();
        if (pages.dashboard.style.display !== 'none') {
            draw();
        }
        if (pages.monitoring.style.display !== 'none') {
            drawMirror();
        }
    });
    // Initial fit
    fitCanvas();
    let timer = null;
    function start() {
      if (running || mode.value !== 'Operate') return;
      running = true;
      refreshLED();
      badge.textContent = 'Running';
      currentStep = 0;
      monitoringData.length = 0;
      tableBody.innerHTML = '';
      timer = setInterval(sample, SAMPLE_MS);
    }
    function stop() {
      running = false;
      refreshLED();
      badge.textContent = 'Idle';
      clearInterval(timer);
      timer = null;
    }
    btnExec.addEventListener('click', () => running ? stop() : start());
    mode.addEventListener('change', () => {
      if (mode.value === 'Standby') stop();
      refreshLED();
    });
    function sample() {
      const now = new Date();
      let vKg = readSensorKg() - zeroOffsetKg;
      buffer.push({
        t: now,
        vKg
      });
      const cutoff = now.getTime() - MAX_SEC * 1000;
      while (buffer.length && buffer[0].t.getTime() < cutoff) buffer.shift();
      // Add to monitoring data
      const unit = unitEl.value;
      const displayValue = fromKg(vKg, unit).toFixed(2) + ' ' + unit;
      monitoringData.push({
        timestamp: now,
        value: displayValue,
        valueKg: vKg
      });
      // Update table
      const no = monitoringData.length; // Start from 1
      const tsText = now.toLocaleString('id-ID', {
        hour12: false
      });
      const valText = displayValue;
      const row = document.createElement('tr');
      const col1 = document.createElement('td');
      const col2 = document.createElement('td');
      const col3 = document.createElement('td');
      const col4 = document.createElement('td');
      const col5 = document.createElement('td');
      const col6 = document.createElement('td');
      if (no % 2 === 1) {
        // Odd (1,3,5,...): New row with left group filled, right empty
        col1.textContent = no;
        col2.textContent = tsText;
        col3.textContent = valText;
        col4.textContent = '';
        col5.textContent = '';
        col6.textContent = '';
        row.appendChild(col1);
        row.appendChild(col2);
        row.appendChild(col3);
        row.appendChild(col4);
        row.appendChild(col5);
        row.appendChild(col6);
        tableBody.appendChild(row);
      } else {
        // Even (2,4,6,...): Fill right group of last row
        const lastRow = tableBody.lastChild;
        if (lastRow) {
          lastRow.children[3].textContent = no;
          lastRow.children[4].textContent = tsText;
          lastRow.children[5].textContent = valText;
        }
      }
      // Update monitoring info
      monitorOperator.textContent = username.value;
      monitorSetpoint.textContent = parseFloat(setpointEl.value).toFixed(2) + ' ' + unit;
      // Naikkan step
      if (currentStep < 100) {
        currentStep += 5;
      }
      valReal.textContent = displayValue;
      valSet.textContent = parseFloat(setpointEl.value || 0).toFixed(2) + ' ' + unit;
      draw();
      drawMirror();
    }
    document.getElementById('btnZero').addEventListener('click', () => {
      const last = buffer[buffer.length - 1];
      if (last) {
        zeroOffsetKg += last.vKg;
      }
      currentStep = 0;
    });
    function draw() {
      if (!cvs || !cvs.getContext) return;
      const ctx = cvs.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const w = cvs.width,
        h = cvs.height;
      if (w <= 0 || h <= 0) return;
      ctx.clearRect(0, 0, w, h);
      ctx.save();
      ctx.scale(dpr, dpr);
      const L = 70,
        R = 20,
        T = 20,
        B = 40;
      const PW = (w / dpr) - L - R,
        PH = (h / dpr) - T - B;
      const now = Date.now();
      const t0 = now - MAX_SEC * 1000;
      let maxKg = Math.max(1, Math.max(...buffer.map(p => p.vKg), toKg(parseFloat(setpointEl.value || 0), unitEl.value)) * 1.25);
      maxKg = Math.ceil(maxKg / 10) * 10; // Round up to nearest 10
      const minKg = 0;
      const x = tms => L + ((tms - t0) / (MAX_SEC * 1000)) * PW;
      const y = vKg => T + (1 - (vKg - minKg) / (maxKg - minKg)) * PH;
      ctx.strokeStyle = '#E7ECEB';
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let i = 0; i <= 10; i++) { // More grids for smaller steps
        const yy = T + PH * (i / 10);
        ctx.moveTo(L, yy);
        ctx.lineTo((w / dpr) - R, yy);
      }
      ctx.stroke();
      ctx.fillStyle = '#6B7280';
      ctx.font = `12px system-ui`;
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= 10; i += 2) { // Labels every 20% (every 2/10)
        const val = minKg + (maxKg - minKg) * (1 - i / 10);
        const yy = T + PH * (i / 10);
        ctx.fillText(val.toFixed(2) + ' kg', L - 8, yy);
      }
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      for (let s = Math.ceil(MAX_SEC / 6) * -6; s <= 0; s += 20) {
        const t = now + s * 1000;
        const xx = x(t);
        const d = new Date(t);
        const label = d.toLocaleTimeString('id-ID', {
          hour12: false,
          timeStyle: 'medium'
        });
        ctx.fillText(label, xx, T + PH + 10);
      }
      ctx.strokeStyle = '#F59E0B';
      ctx.setLineDash([6, 6]);
      ctx.beginPath();
      ctx.moveTo(L, y(0));
      ctx.lineTo((w / dpr) - R, y(0));
      ctx.stroke();
      ctx.setLineDash([]);
      const spKg = toKg(parseFloat(setpointEl.value || 0), unitEl.value);
      ctx.strokeStyle = '#10B981';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(L, y(spKg));
      ctx.lineTo((w / dpr) - R, y(spKg));
      ctx.stroke();
      if (buffer.length >= 2) {
        ctx.strokeStyle = '#1678FF';
        ctx.lineWidth = 3;
        ctx.beginPath();
        buffer.forEach((p, i) => {
          const xx = x(p.t.getTime());
          const yy = y(p.vKg);
          if (i === 0) ctx.moveTo(xx, yy);
          else ctx.lineTo(xx, yy);
        });
        ctx.stroke();
        // Add points
        ctx.fillStyle = '#1678FF';
        buffer.forEach(p => {
          const xx = x(p.t.getTime());
          const yy = y(p.vKg);
          ctx.beginPath();
          ctx.arc(xx, yy, 5, 0, 2 * Math.PI);
          ctx.fill();
        });
      }
      ctx.restore();
    }
    function drawMirror() {
      if (!mirrorCvs || !mirrorCvs.getContext || monitoringData.length < 2) return;
      const ctx = mirrorCvs.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const w = mirrorCvs.width,
        h = mirrorCvs.height;
      if (w <= 0 || h <= 0) return;
      ctx.clearRect(0, 0, w, h);
      ctx.save();
      ctx.scale(dpr, dpr);
      const L = 70,
        R = 20,
        T = 20,
        B = 40;
      const PW = (w / dpr) - L - R,
        PH = (h / dpr) - T - B;
      const data = monitoringData;
      let maxKg = Math.max(1, Math.max(...data.map(d => d.valueKg), toKg(parseFloat(setpointEl.value || 0), unitEl.value)) * 1.25);
      maxKg = Math.ceil(maxKg / 10) * 10; // Round up to nearest 10
      const minKg = 0;
      const x = (index) => L + (index / (data.length - 1)) * PW;
      const y = (vKg) => T + (1 - (vKg - minKg) / (maxKg - minKg)) * PH;
      // Grid
      ctx.strokeStyle = '#E7ECEB';
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let i = 0; i <= 10; i++) { // More grids
        const yy = T + PH * (i / 10);
        ctx.moveTo(L, yy);
        ctx.lineTo((w / dpr) - R, yy);
      }
      ctx.stroke();
      // Y labels
      ctx.fillStyle = '#6B7280';
      ctx.font = `12px system-ui`;
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= 10; i += 2) {
        const val = minKg + (maxKg - minKg) * (1 - i / 10);
        const yy = T + PH * (i / 10);
        ctx.fillText(val.toFixed(2) + ' kg', L - 8, yy);
      }
      // X labels
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      const numLabels = Math.min(6, data.length);
      for (let i = 0; i < numLabels; i++) {
        const index = Math.floor(i * (data.length - 1) / (numLabels - 1));
        const d = data[index].timestamp;
        const label = d.toLocaleTimeString('id-ID', {
          hour12: false,
          timeStyle: 'medium'
        });
        const xx = x(index);
        ctx.fillText(label, xx, T + PH + 10);
      }
      // Zero line
      ctx.strokeStyle = '#F59E0B';
      ctx.setLineDash([6, 6]);
      ctx.beginPath();
      ctx.moveTo(L, y(0));
      ctx.lineTo((w / dpr) - R, y(0));
      ctx.stroke();
      ctx.setLineDash([]);
      // Setpoint line
      const spKg = toKg(parseFloat(setpointEl.value || 0), unitEl.value);
      ctx.strokeStyle = '#10B981';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(L, y(spKg));
      ctx.lineTo((w / dpr) - R, y(spKg));
      ctx.stroke();
      // Data line
      if (data.length >= 2) {
        ctx.strokeStyle = '#1678FF';
        ctx.lineWidth = 3;
        ctx.beginPath();
        data.forEach((d, i) => {
          const xx = x(i);
          const yy = y(d.valueKg);
          if (i === 0) ctx.moveTo(xx, yy);
          else ctx.lineTo(xx, yy);
        });
        ctx.stroke();
        // Add points
        ctx.fillStyle = '#1678FF';
        data.forEach((d, i) => {
          const xx = x(i);
          const yy = y(d.valueKg);
          ctx.beginPath();
          ctx.arc(xx, yy, 5, 0, 2 * Math.PI);
          ctx.fill();
        });
      }
      ctx.restore();
    }
    box.addEventListener('pointermove', e => {
      if (!cvs || buffer.length === 0) return;
      const rect = box.getBoundingClientRect();
      const rx = (e.clientX - rect.left) * (cvs.width / rect.width);
      const L = 70 * (window.devicePixelRatio || 1),
        R = 20 * (window.devicePixelRatio || 1);
      const w = cvs.width;
      const now = Date.now();
      const t0 = now - MAX_SEC * 1000;
      const tHover = t0 + ((rx - L) / (w - L - R)) * (MAX_SEC * 1000);
      let idx = 0;
      let best = 1e12;
      for (let i = 0; i < buffer.length; i++) {
        const d = Math.abs(buffer[i].t.getTime() - tHover);
        if (d < best) {
          best = d;
          idx = i;
        }
      }
      const p = buffer[idx];
      const px = ((p.t.getTime() - t0) / (MAX_SEC * 1000)) * (rect.width - 16) + 8;
      cross.style.left = px + 'px';
      cross.hidden = false;
      tipT.textContent = p.t.toLocaleTimeString('id-ID', {
        hour12: false,
        timeStyle: 'medium'
      });
      const unit = unitEl.value;
      tipV.textContent = (fromKg(p.vKg, unit)).toFixed(2) + ' ' + unit;
      tip.style.left = px + 'px';
      tip.style.top = '40px';
      tip.hidden = false;
    });
    box.addEventListener('pointerleave', () => {
      cross.hidden = true;
      tip.hidden = true;
    });
    unitEl.addEventListener('change', () => {
      valSet.textContent = parseFloat(setpointEl.value || 0).toFixed(2) + ' ' + unitEl.value;
      monitorSetpoint.textContent = parseFloat(setpointEl.value || 0).toFixed(2) + ' ' + unitEl.value;
    });
    setpointEl.addEventListener('input', () => {
      const u = unitEl.value;
      const n = parseFloat(setpointEl.value || 0);
      setpointEl.value = isNaN(n) ? '0.00' : n.toFixed(2);
      valSet.textContent = setpointEl.value + ' ' + u;
      monitorSetpoint.textContent = setpointEl.value + ' ' + u;
    });
    // Initialize values
    valSet.textContent = parseFloat(setpointEl.value).toFixed(2) + ' ' + unitEl.value;
    monitorSetpoint.textContent = parseFloat(setpointEl.value).toFixed(2) + ' ' + unitEl.value;
    refreshLED();
    // Initial draw after a short delay to ensure canvas is ready
    setTimeout(() => {
        fitCanvas();
        draw();
    }, 100);
    // Save button
    btnSave.addEventListener('click', () => {
      btnSave.style.display = 'none';
      html2canvas(document.querySelector('.monitoring-card')).then(canvas => {
        btnSave.style.display = '';
        const link = document.createElement('a');
        link.download = 'monitoring_data.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    });
    // ===== Report Form Logic =====
    const formSections = Array.from(document.querySelectorAll(".form-section"));
    const formProgressText = document.getElementById("form-progress");
    const formProgressBar = document.getElementById("form-progress-bar");
    let currentFormSection = 0;
    const formAnswers = {};
    // ===== Image Upload Logic =====
    const fileInput = document.getElementById('fileInput');
    const imageGrid = document.getElementById('imageGrid');
    let uploadedImages = [];
    // Fungsi untuk menambahkan gambar ke grid
    function addImageToGrid(file, name) {
        const imageUrl = URL.createObjectURL(file);
        const imageId = Date.now() + Math.random(); // ID unik untuk gambar
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        imageItem.dataset.id = imageId;
        imageItem.innerHTML = `
            <div class="image-preview">
                <img src="${imageUrl}" alt="${name}">
            </div>
            <div class="image-info">
                <div class="image-name" contenteditable="true">${name}</div>
                <div class="image-actions">
                    <button class="btn btn-outline" title="Ubah Nama">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                      </svg>
                    </button>
                    <button class="btn btn-danger" title="Hapus">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
        `;
        // Tambahkan event listener untuk tombol hapus
        const deleteBtn = imageItem.querySelector('.btn-danger');
        deleteBtn.addEventListener('click', () => {
            uploadedImages = uploadedImages.filter(img => img.id !== imageId);
            imageItem.remove();
        });
        // Tambahkan event listener untuk edit nama
        const editBtn = imageItem.querySelector('.btn-outline');
        const imageNameEl = imageItem.querySelector('.image-name');
        editBtn.addEventListener('click', () => {
            imageNameEl.focus();
        });
        imageNameEl.addEventListener('blur', () => {
            const img = uploadedImages.find(img => img.id === imageId);
            if (img) img.name = imageNameEl.textContent.trim();
        });
        imageGrid.appendChild(imageItem);
        uploadedImages.push({ id: imageId, file, name, url: imageUrl });
    }
    fileInput.addEventListener('change', e => {
      Array.from(e.target.files).forEach(file => {
        if (file.type.startsWith('image/')) addImageToGrid(file, file.name);
      });
      e.target.value = '';
    });
    // ===== Form Navigation =====
    let currentSection = 0;
    function showSection(index) {
      formSections.forEach((section, i) => {
        section.style.display = i === index ? 'block' : 'none';
      });
      formProgressText.textContent = `Page ${index + 1} of 8`;
      formProgressBar.style.width = `${((index + 1) / 8) * 100}%`;
    }
    function nextFormSection() {
      if (currentSection < formSections.length - 1) {
        currentSection++;
        showSection(currentSection);
      }
    }
    function prevFormSection() {
      if (currentSection > 0) {
        currentSection--;
        showSection(currentSection);
      }
    }
    showSection(currentSection);
    // ===== Yes/No Toggle =====
    const ynRows = document.querySelectorAll('.yn-row');
    ynRows.forEach(row => {
      const name = row.dataset.name;
      const boxes = row.querySelectorAll('.yn-box');
      boxes.forEach(box => {
        box.addEventListener('click', () => {
          boxes.forEach(b => b.classList.remove('selected'));
          box.classList.add('selected');
          formAnswers[name] = box.dataset.value;
          if (name === 'first_exam') {
            document.getElementById('installedCorrectlyGroup').style.display = box.dataset.value === 'YES' ? 'block' : 'none';
          }
        });
      });
    });
    // ===== Export Report to HTML =====
    document.getElementById('exportReportBtn').addEventListener('click', async () => { // Gunakan ID tombol baru
      // Validasi sederhana: pastikan berada di halaman terakhir
      if (currentSection !== 7) { // Section 8 adalah index 7
        alert("Please navigate to the 'Import Image' section (Page 8) before exporting.");
        return;
      }

      // Kumpulkan data dari semua input, select, textarea
      const data = {};
      const inputs = document.querySelectorAll('#reportPage input, #reportPage select, #reportPage textarea');
      inputs.forEach(input => {
        // Untuk input tanggal, gunakan nilai asli (valueAsDate bisa null)
        if (input.type === 'date') {
            data[input.id] = input.value; // Format YYYY-MM-DD
        } else {
            data[input.id] = input.value;
        }
      });

      // Kumpulkan jawaban dari toggle YES/NO
      const ynRows = document.querySelectorAll('#reportPage .yn-row');
      ynRows.forEach(row => {
        const name = row.dataset.name;
        const selectedBox = row.querySelector('.yn-box.selected');
        data[name] = selectedBox ? selectedBox.dataset.value : 'NO'; // Default 'NO' jika tidak ada yang dipilih
      });

      // Format tanggal untuk ditampilkan (opsional, jika perlu format lokal)
      // const formatDate = (dateStr) => {
      //   if (!dateStr) return '';
      //   const date = new Date(dateStr);
      //   return isNaN(date) ? '' : date.toLocaleDateString('id-ID'); // atau 'en-CA' untuk YYYY-MM-DD
      // };

      // Generate base64 untuk gambar
      const imagesBase64Promises = uploadedImages.map(async img => {
         return new Promise(resolve => {
           const reader = new FileReader();
           reader.onload = () => resolve({ src: reader.result, name: img.name });
           reader.readAsDataURL(img.file);
         });
      });
      const imagesData = await Promise.all(imagesBase64Promises);

      // Bangun konten HTML untuk laporan
      const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thorough Examination Report of Lifting Gears</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #f2f2f2; }
    .header { text-align: center; margin-bottom: 20px; }
    .header h1, .header h2 { margin: 5px 0; }
    .page-break { page-break-before: always; }
    .image-container { margin-bottom: 20px; }
    .image-container img { max-width: 100%; height: auto; display: block; margin: 0 auto 5px auto; }
    .image-caption { text-align: center; font-size: 0.9em; font-style: italic; }
    .section-title { font-size: 1.2em; font-weight: bold; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    .data-row { margin-bottom: 5px; }
    .data-label { font-weight: bold; display: inline-block; width: 300px; } /* Sesuaikan lebar label */
  </style>
</head>
<body>
  <div class="header">
    <h1>PT. SPEKTRA MEGAH SEMESTA</h1>
    <h2>THOROUGH EXAMINATION REPORT OF LIFTING GEARS</h2>
    <p>This report complies with the Lifting Equipment Engineers Association Technical Requirements</p>
  </div>

  <div class="section-title">Document Header</div>
  <table>
    <tr>
      <th>Form No.</th>
      <td>${data.formNo || ''}</td>
      <th>Certificate No</th>
      <td>${data.certificateNo || ''}</td>
    </tr>
    <tr>
      <th>Date of Thorough Examination</th>
      <td>${data.dateOfExamination || ''}</td>
      <th>Date of Report</th>
      <td>${data.dateOfReport || ''}</td>
    </tr>
    <tr>
      <th>Title</th>
      <td colspan="3">${data.reportTitle || ''}</td>
    </tr>
     <tr>
       <th>Compliance Standard</th>
       <td>${data.compliance || ''}</td>
       <th>Regulatory Reference</th>
       <td>${data.reference || ''}</td>
     </tr>
  </table>

  <div class="section-title">Identity of Parties & Location</div>
  <div class="data-row"><span class="data-label">Employer (Name):</span> ${data.employerName || ''}</div>
  <div class="data-row"><span class="data-label">Employer (Address):</span> ${data.employerAddress || ''}</div>
  <div class="data-row"><span class="data-label">Examination Location (Site Name):</span> ${data.siteName || ''}</div>
  <div class="data-row"><span class="data-label">Examination Location (Address):</span> ${data.siteAddress || ''}</div>

  <div class="section-title">Equipment Identity</div>
  <table>
    <tr>
      <th>Equipment Description</th>
      <td>${data.equipmentDesc || ''}</td>
      <th>ID Number</th>
      <td>${data.idNumber || ''}</td>
    </tr>
    <tr>
      <th>Manufacturer</th>
      <td>${data.manufacturer || ''}</td>
      <th>Safety Factor</th>
      <td>${data.safetyFactor || ''}</td>
    </tr>
    <tr>
      <th>Length (mm)</th>
      <td>${data.length || ''}</td>
      <th>Standard Reference</th>
      <td>${data.standardRef || ''}</td>
    </tr>
    <tr>
      <th>SWL (Safe Working Load)</th>
      <td>${data.swl || ''}</td>
      <th>Date of Manufacture</th>
      <td>${data.dateOfManufacture || ''}</td>
    </tr>
    <tr>
      <th colspan="2">Date of Last Thorough Examination</th>
      <td colspan="2">${data.dateOfLastExamination || ''}</td>
    </tr>
  </table>

  <div class="section-title">Technical Test Results</div>
  <table>
    <tr>
      <th>Visual Test</th>
      <td>${data.visualTestResult || ''}</td>
      <th>NDT Test</th>
      <td>${data.ndtTestResult || ''}</td>
    </tr>
    <tr>
      <th>Function Test</th>
      <td>${data.functionTest || ''}</td>
      <th>Load Test</th>
      <td>${data.loadTest || ''}</td>
    </tr>
    <tr>
      <th colspan="2">Name Stamping</th>
      <td colspan="2">${data.nameStamping || ''}</td>
    </tr>
  </table>

  <div class="section-title">Examination Category & Interval</div>
  <table>
    <tr>
      <th>First examination after installation/assembly?</th>
      <td>${data.first_exam || 'NO'}</td>
      <th>Installed correctly? (if first exam YES)</th>
      <td>${(data.first_exam === 'YES') ? (data.installed_correctly || 'NO') : 'N/A'}</td>
    </tr>
    <tr>
      <th>Within 6 months interval?</th>
      <td>${data.interval_6 || 'NO'}</td>
      <th>Within 12 months interval?</th>
      <td>${data.interval_12 || 'YES'}</td>
    </tr>
    <tr>
      <th>In accordance with scheme?</th>
      <td>${data.exam_scheme || 'NO'}</td>
      <th>After exceptional circumstances?</th>
      <td>${data.exceptional_event || 'NO'}</td>
    </tr>
  </table>

  <div class="section-title">Defects Findings & Follow-up</div>
  <div class="data-row"><span class="data-label">Defect Description:</span></div>
  <div>${data.defectDescription || ''}</div>
  <table>
    <tr>
      <th>Immediate danger?</th>
      <td>${data.hazard_immediate || 'NO'}</td>
      <th>Potential danger? (Date by when)</th>
      <td>${data.hazard_potential || 'NO'}${(data.hazard_potential === 'YES' && data.repairDeadline) ? ` by: ${data.repairDeadline}` : ''}</td>
    </tr>
  </table>
  <div class="data-row"><span class="data-label">Additional Tests:</span> ${data.additionalTests || ''}</div>
  <div class="data-row"><span class="data-label">Repair Details:</span></div>
  <div>${data.repairDetails || ''}</div>
  <div class="data-row"><span class="data-label">Fit for Purpose?</span> ${data.fit_for_purpose || 'YES'}</div>

  <div class="section-title">Officers & Authorization</div>
  <table>
    <tr>
      <th>Inspector Name & Qualification</th>
      <td>${data.inspectorName || ''}<br>${data.inspectorQualification || ''}</td>
      <th>Authenticator Name & Role</th>
      <td>${data.authenticatorName || ''}<br>${data.authenticatorRole || ''}</td>
    </tr>
    <tr>
      <th>Next Examination Date</th>
      <td>${data.nextExaminationDate || ''}</td>
      <th>Company Info</th>
      <td>${data.companyName || ''}<br>${data.companyAddress || ''}<br>${data.companyContact || ''}</td>
    </tr>
  </table>

  <div class="page-break"></div>
  <div class="section-title">Imported Images</div>
  ${
    imagesData.length > 0 ?
    imagesData.map(imgData => `
      <div class="image-container">
        <img src="${imgData.src}" alt="Imported Image: ${imgData.name}">
        <div class="image-caption">${imgData.name}</div>
      </div>
    `).join('') :
    '<p>No images uploaded.</p>'
  }
</body>
</html>
      `;

      // Unduh HTML
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'lifting_gear_report.html'; // Nama file yang lebih deskriptif
      document.body.appendChild(a); // Diperlukan untuk Firefox
      a.click();
      document.body.removeChild(a); // Bersihkan
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>